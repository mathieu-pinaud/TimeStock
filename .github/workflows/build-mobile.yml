name: Build MAUI Android & iOS

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Installer .NET SDK 8
        run: |
          curl -fsSL https://dot.net/v1/dotnet-install.sh | bash /dev/stdin --install-dir $HOME/.dotnet --version 8.0.112
          echo "DOTNET_ROOT=$HOME/.dotnet" >> $GITHUB_ENV
          echo "$HOME/.dotnet" >> $GITHUB_PATH

      - name: Installer MAUI Android
        run: |
          dotnet workload restore
          dotnet workload install maui-android

      - name: Build Shared
        run: |
          dotnet restore src/Shared/Shared.csproj
          dotnet build src/Shared/Shared.csproj -c Release

      - name: Build Client
        run: |
          dotnet restore src/Client/Client.csproj
          dotnet build src/Client/Client.csproj -c Release

      - name: Build Android
        run: |
          dotnet restore src/Mobile/Mobile.Android.csproj
          dotnet build src/Mobile/Mobile.Android.csproj -c Release
          dotnet publish src/Mobile/Mobile.Android.csproj -c Release -o out

      - name: Upload Android Build
        uses: actions/upload-artifact@v4
        with:
          name: android-build
          path: src/Mobile/out

  build-ios:
    runs-on: macos-latest
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Installer .NET SDK 8 (macOS)
        run: |
          sudo brew install --cask dotnet-sdk
          echo "DOTNET_ROOT=/usr/local/share/dotnet" >> $GITHUB_ENV
          echo "/usr/local/share/dotnet" >> $GITHUB_PATH

      - name: Installer MAUI iOS
        run: |
          sudo dotnet workload restore
          sudo dotnet workload install maui-ios

      - name: Build Shared
        run: |
          dotnet restore src/Shared/Shared.csproj
          dotnet build src/Shared/Shared.csproj -c Release

      - name: Build Client
        run: |
          dotnet restore src/Client/Client.csproj
          dotnet build src/Client/Client.csproj -c Release

      - name: Build iOS
        run: |
          dotnet restore src/Mobile/Mobile.iOS.csproj
          dotnet build src/Mobile/Mobile.iOS.csproj -c Release
          dotnet publish src/Mobile/Mobile.iOS.csproj -c Release -o out

      - name: Upload iOS Build
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: src/Mobile/out
